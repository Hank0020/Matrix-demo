<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ©é™£èˆ‡èƒ½é‡æ¢æ§åˆ¶ (JSON è¼¸å‡º)</title>
    <style>
        /* ------------------------------------- */
        /* I. æ•´é«”ä½ˆå±€è¨­å®š */
        /* ------------------------------------- */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center; /* è®“æ‰€æœ‰å­å…ƒç´ ï¼ˆæ¨™é¡Œã€å®¹å™¨ã€è¼¸å‡ºå€ï¼‰æ°´å¹³ç½®ä¸­ */
            padding-top: 30px;
        }

        /* çŸ©é™£èˆ‡åŠ›é‡æ§åˆ¶æ¢çš„æ°´å¹³å®¹å™¨ï¼šç”¨æ–¼å¯¦ç¾çŸ©é™£å±…ä¸­ï¼ŒåŠ›é‡æ¢é å³ */
        #main-content-row {
            display: flex;
            flex-direction: row; 
            justify-content: flex-start; /* å¾å·¦é‚Šé–‹å§‹æ’ */
            align-items: center; /* è®“çŸ©é™£å’ŒåŠ›é‡æ¢å®¹å™¨çš„é ‚éƒ¨å°é½Š */
            width: 90%; 
            max-width: 900px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            
            margin-top: 20px;
            /* ä¿®æ­£æ»‘å¡Šæº¢å‡ºï¼Œç¢ºä¿ä¸‹æ–¹æœ‰è¶³å¤ çš„å‚ç›´ç©ºé–“ */
            margin-bottom: 30px; 
        }

        /* ------------------------------------- */
        /* II. çŸ©é™£å€å¡Šæ¨£å¼ */
        /* ------------------------------------- */
        /* çŸ©é™£å®¹å™¨ (ç½®ä¸­å…ƒç´ ) */
        #matrix-container { 
            flex-shrink: 0; 
            /* ã€é—œéµå±…ä¸­ã€‘è‡ªå‹•ä½”æ“šå·¦å´ç©ºé–“ï¼Œå°‡çŸ©é™£æ¨å‘ä¸­å¿ƒ */
            margin-left: auto;
            /* èª¿æ•´é–“è·ã€‚æ­¤è™•ä¿æŒè² å€¼ä¾†ç¸®å°çŸ©é™£èˆ‡åŠ›é‡æ¢çš„è·é›¢ */
            margin-right: -175px; 
        }
        
        #matrix { 
            border-collapse: collapse; 
            table-layout: fixed; 
        }
        #matrix td {
            width: 50px;
            height: 50px;
            border: 1px solid #333;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        #matrix td:hover { 
            background-color: #d8eaff; 
        }
        .highlight {
            background-color: #007bff !important;
            color: white;
            font-weight: bold;
        }

        /* ------------------------------------- */
        /* III. å‚ç›´åŠ›é‡æ§åˆ¶æ¢æ¨£å¼ */
        /* ------------------------------------- */
        /* åŠ›é‡æ§åˆ¶æ¢çš„å®¹å™¨ (é å³å…ƒç´ ) */
        #power-control {
            width: 150px; 
            height: 300px;
            margin: 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            
            /* ã€é—œéµé å³ã€‘è‡ªå‹•ä½”æ“šä¸­é–“å‰©é¤˜ç©ºé–“ï¼Œå°‡åŠ›é‡æ¢æ¨åˆ°æœ€å³é‚Š */
            margin-left: auto; 
            
            /* å…§éƒ¨ Flexbox è¨­å®š */
            display: flex;
            flex-direction: column; 
            align-items: center; 
        }
        
        /* èƒ½é‡æ¢æ¨™ç±¤çš„æ¨£å¼ */
        #power-control label {
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center; 
        }

        /* æ•¸å€¼é¡¯ç¤º */
        #power-value {
            color: #d9534f;
            font-weight: bold;
            font-size: 1.1em;
            display: inline-block;
            min-width: 30px;
            text-align: center;
        }

        /* èƒ½é‡æ¢æœ¬èº« (å‚ç›´æ»‘å¡Š) */
        #power-slider {
            /* å‚ç›´åŒ–é—œéµ */
            transform: rotate(270deg); 
            width: 250px; 
            height: 15px;
            transform-origin: 125px 125px; /* æ—‹è½‰ä¸­å¿ƒé» */
            
            /* å¾®èª¿æ»‘å¡Šä½ç½®ï¼Œä½¿å…¶åœ¨å®¹å™¨å…§å±…ä¸­ä¸”ä¸æº¢å‡º */
            margin-top: -10px; 
            margin-left: 235px;
        }
        
        /* ------------------------------------- */
        /* IV. æŒ‰éˆ•èˆ‡ JSON è¼¸å‡ºå€å¡Šæ¨£å¼ */
        /* ------------------------------------- */
        
        /* ç¢ºèªæŒ‰éˆ•å®¹å™¨ */
        #action-area {
            /* è®“æŒ‰éˆ•å€å¡Šèˆ‡çŸ©é™£å’Œ JSON è¼¸å‡ºå€å°é½Š */
            width: 80%;
            max-width: 300px; 
            text-align: center;
            margin: 0px auto 0 auto; /* ç¢ºä¿æ°´å¹³ç½®ä¸­ä¸¦èˆ‡ä¸Šæ–¹ä¿æŒè·é›¢ */
        }
        
        #confirm-button {
            padding: 10px 20px;
            font-size: 1.1em;
            cursor: pointer;
            background-color: #28a745; 
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        #confirm-button:hover {
            background-color: #1e7e34;
        }

        /* è¼¸å‡ºæ¨™é¡Œ (è®“å®ƒèˆ‡æŒ‰éˆ•ã€JSON è¼¸å‡ºå€å¡Šä¸€åŒç½®ä¸­) */
        h2 {
            /* æ¸›å°‘èˆ‡ä¸Šæ–¹æŒ‰éˆ•çš„è·é›¢ */
            margin-top: 15px; 
            
            width: 80%;
            max-width: 300px; 
            text-align: center;
            margin-left: auto;
            margin-right: auto;
        }

        /* JSON è¼¸å‡ºå€ */
        #output {
            font-size: 1.2em;
            background-color: #f4f4f4;
            padding: 10px;
            border: 1px dashed #ccc;
            width: 80%;
            max-width: 300px; /* å¯¬åº¦èˆ‡çŸ©é™£å°é½Š */
            text-align: left;
            word-wrap: break-word;
            font-family: monospace;
            color: #1abc9c;
            min-height: 50px;
            
            /* å€å¡Šè‡ªèº«æ°´å¹³å±…ä¸­ */
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body>

    <h1>Target and Power Control</h1>
    
    <div id="main-content-row">
        
        <div id="matrix-container">
            <table id="matrix"></table>
        </div>

        <div id="power-control">
            <label for="power-slider">
                Power value: <span id="power-value">50</span>
            </label>
            <input type="range" id="power-slider" min="0" max="255" value="50" step="1">
        </div>

    </div>
    
    <div id="action-area">
        <button id="confirm-button">Confirm sending data</button>
    </div>

    <h2>Output JSON data:</h2>
    <div id="output">
        Please click on the grid and adjust the power bar.
    </div>

    <script>
        const ROWS = 5;
        const COLS = 5;
        const CENTER_OFFSET = Math.floor(ROWS / 2); // 2
        
        const matrixTable = document.getElementById('matrix');
        const outputDiv = document.getElementById('output');
        const powerSlider = document.getElementById('power-slider');
        const powerValueSpan = document.getElementById('power-value');
        const confirmButton = document.getElementById('confirm-button'); // å–å¾—æŒ‰éˆ•å…ƒç´ 
        
        let lastClickedCell = null;
        let pendingPayload = null; // ã€æ–°å¢ã€‘ç”¨æ–¼æš«å­˜å¾…ç™¼é€çš„æ•¸æ“š

        // ç›£è½èƒ½é‡æ¢çš„è®Šå‹•ï¼Œå³æ™‚æ›´æ–°é¡¯ç¤ºå€¼å’Œæš«å­˜æ•¸æ“š
        powerSlider.addEventListener('input', function() {
            powerValueSpan.textContent = this.value;
            // å¦‚æœæœ‰é¸ä¸­çš„æ ¼å­ï¼ŒåŒæ­¥æ›´æ–°æš«å­˜æ•¸æ“š
            if (lastClickedCell) {
                updatePendingPayload(lastClickedCell.dataset.row, lastClickedCell.dataset.col, this.value);
            }
        });

        // ã€æ–°å¢ã€‘æ›´æ–°æš«å­˜æ•¸æ“šçš„è¼”åŠ©å‡½æ•¸
        function updatePendingPayload(row, col, power) {
            // 1. è¨ˆç®—ä¸­å¿ƒé»åº§æ¨™ (-2 åˆ° +2)
            const xCoord = col - CENTER_OFFSET;       
            const yCoord = CENTER_OFFSET - row;       
            const powerLevel = parseInt(power); 

            // 2. å»ºç«‹ JSON Payload ä¸¦å„²å­˜åˆ°æš«å­˜è®Šæ•¸
            pendingPayload = {
                x: xCoord,
                y: yCoord,
                power: powerLevel,
                timestamp: Date.now()  
            };

            // 3. è¼¸å‡ºåˆ°ç¶²é é¡¯ç¤ºå€åŸŸ
            const jsonString = JSON.stringify(pendingPayload, null, 2);
            outputDiv.textContent = jsonString;
        }
        
        // ã€æ–°å¢ã€‘è™•ç†ç¢ºèªæŒ‰éˆ•é»æ“Šçš„å‡½æ•¸ï¼šå¯¦éš›ç™¼é€æ•¸æ“š
        function handleConfirm() {
            if (!pendingPayload) {
                alert("éŒ¯èª¤ï¼šæ²’æœ‰å¾…ç¢ºèªçš„æ•¸æ“šã€‚è«‹å…ˆé»æ“ŠçŸ©é™£ã€‚");
                console.log("Error: æ²’æœ‰å¾…ç¢ºèªçš„æ•¸æ“šã€‚è«‹å…ˆé»æ“ŠçŸ©é™£ã€‚");
                return;
            }

            const finalJsonString = JSON.stringify(pendingPayload, null, 2);
            
            console.log("ğŸš€ æ•¸æ“šå·²ç™¼é€:", finalJsonString);
            
            alert("æ•¸æ“šå·²ç™¼é€:\n" + finalJsonString); // æ¨¡æ“¬ç™¼é€å›é¥‹
            
            // ğŸ’¡ å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæœƒåœ¨é€™è£¡ç™¼é€ WebSocket æ•¸æ“š
            // if (ws && ws.readyState === WebSocket.OPEN) {
            //     ws.send(finalJsonString);
            // }
            
            // å¯é¸ï¼šç™¼é€å¾Œæ¸…é™¤æš«å­˜æ•¸æ“šæˆ–è¦–è¦ºæ•ˆæœ
            // pendingPayload = null;
        }

        /**
         * è™•ç†é»æ“Šäº‹ä»¶çš„å‡½å¼ï¼šåªå„²å­˜æ•¸æ“šï¼Œä¸ç™¼é€
         */
        function handleClick(row, col, cellElement) {
            
            // 1. è¦–è¦ºå›é¥‹å’Œå„²å­˜åº§æ¨™
            if (lastClickedCell) {
                lastClickedCell.classList.remove('highlight');
                lastClickedCell.textContent = '';
            }
            
            cellElement.classList.add('highlight');
            cellElement.textContent = `(${col - CENTER_OFFSET}, ${CENTER_OFFSET - row})`;
            lastClickedCell = cellElement;
            
            // 2. å°‡ row å’Œ col å­˜åˆ° data å±¬æ€§ï¼Œä»¥ä¾¿æ»‘å¡Šè®Šå‹•æ™‚å–ç”¨
            cellElement.dataset.row = row;
            cellElement.dataset.col = col;
            
            // 3. æ›´æ–°æš«å­˜å€å’Œ JSON é¡¯ç¤º
            updatePendingPayload(row, col, powerSlider.value);
        }

        /**
         * å‹•æ…‹ç”Ÿæˆ 5x5 çš„ HTML è¡¨æ ¼
         */
        function createMatrix() {
            for (let r = 0; r < ROWS; r++) {
                let row = matrixTable.insertRow();
                for (let c = 0; c < COLS; c++) {
                    let cell = row.insertCell();
                    
                    cell.onclick = function() {
                        handleClick(r, c, this);
                    };

                    
                }
            }
            
            // é é¢è¼‰å…¥å¾Œï¼Œç¶å®šç¢ºèªæŒ‰éˆ•äº‹ä»¶
            confirmButton.addEventListener('click', handleConfirm);
        }

        // é é¢è¼‰å…¥å¾ŒåŸ·è¡Œç”ŸæˆçŸ©é™£
        window.onload = createMatrix;
    </script>

</body>
</html>